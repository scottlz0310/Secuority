# GitHub Actions workflow for Trivy security scanning
# Scans filesystem, secrets, and misconfigurations
name: Trivy Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Weekly full scan on Sundays at 3 AM UTC
    - cron: "0 3 * * 0"

permissions:
  contents: read
  security-events: write

jobs:
  trivy-fs-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-fs-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-fs-results.sarif"
          category: "trivy-fs"

  trivy-config-scan:
    name: Trivy Config Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy config scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: "config"
          scan-ref: "."
          format: "sarif"
          output: "trivy-config-results.sarif"
          severity: "CRITICAL,HIGH,MEDIUM"
          exit-code: "0"

      - name: Upload Trivy config scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-config-results.sarif"
          category: "trivy-config"

  trivy-secret-scan:
    name: Trivy Secret Scan
    runs-on: ubuntu-latest
    # Run secret scan only on push to main or scheduled runs (not on PRs to avoid noise)
    if: github.event_name == 'push' || github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy secret scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "secret"
          format: "sarif"
          output: "trivy-secret-results.sarif"
          exit-code: "0"

      - name: Upload Trivy secret scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-secret-results.sarif"
          category: "trivy-secret"

  trivy-full-scan:
    name: Trivy Full Scan (Weekly)
    runs-on: ubuntu-latest
    # Run full scan only on schedule
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Run Trivy full vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: "fs"
          scan-ref: "."
          scanners: "vuln,secret,misconfig"
          format: "json"
          output: "trivy-full-results.json"
          severity: "CRITICAL,HIGH,MEDIUM,LOW"
          exit-code: "0"

      - name: Display Trivy scan summary
        if: always()
        run: |
          if [ -f "trivy-full-results.json" ]; then
            echo "=== Trivy Full Scan Summary ==="
            python3 - <<'PY'
          import json
          with open("trivy-full-results.json") as f:
              data = json.load(f)
          results = data.get('Results', [])
          total_vulns = sum(len(r.get('Vulnerabilities', [])) for r in results)
          total_secrets = sum(len(r.get('Secrets', [])) for r in results)
          total_misconfig = sum(len(r.get('Misconfigurations', [])) for r in results)
          print(f'Vulnerabilities: {total_vulns}')
          print(f'Secrets: {total_secrets}')
          print(f'Misconfigurations: {total_misconfig}')
          PY
          fi

      - name: Upload Trivy full scan report
        uses: actions/upload-artifact@v6
        with:
          name: trivy-full-scan-report
          path: trivy-full-results.json
          retention-days: 30
